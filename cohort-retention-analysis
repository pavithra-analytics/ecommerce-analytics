/* Step 1: Get each user's first activity date (cohort) */
WITH first_activity AS (
    SELECT
        user_id,
        MIN(DATE(event_time)) AS cohort_date
    FROM ecommerce
    GROUP BY user_id
),

/* Step 2: Get all user activity with cohort date */
user_activity AS (
    SELECT
        e.user_id,
        DATE(e.event_time) AS activity_date,
        f.cohort_date
    FROM ecommerce e
    JOIN first_activity f
        ON e.user_id = f.user_id
),

/* Step 3: Calculate days since cohort signup */
cohort_index AS (
    SELECT
        user_id,
        cohort_date,
        activity_date,
        DATE(activity_date) - DATE(cohort_date) AS days_since_signup
    FROM user_activity
),

/* Step 4: Count active users per cohort per day */
cohort_counts AS (
    SELECT
        cohort_date,
        days_since_signup,
        COUNT(DISTINCT user_id) AS active_users
    FROM cohort_index
    GROUP BY cohort_date, days_since_signup
),

/* Step 5: Get cohort size (total users per cohort) */
cohort_size AS (
    SELECT
        cohort_date,
        COUNT(DISTINCT user_id) AS total_users
    FROM first_activity
    GROUP BY cohort_date
)

/* Step 6: Final retention table */
SELECT
    c.cohort_date,
    c.days_since_signup,
    c.active_users,
    s.total_users,
    ROUND(c.active_users * 100.0 / s.total_users, 2) AS retention_percent
FROM cohort_counts c
JOIN cohort_size s
    ON c.cohort_date = s.cohort_date
ORDER BY c.cohort_date, c.days_since_signup;
